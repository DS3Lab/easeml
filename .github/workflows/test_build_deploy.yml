name: TestBuildPublish
on: 
    push:
      branches:
            - workflow
env:
    CI: true
jobs:
    prepare:
        runs-on: ubuntu-latest
        strategy:
          matrix:
            node-version: [12.x]

        steps:
            - name: Set up Go 1.13
              uses: actions/setup-go@v1
              with:
                go-version: 1.13
              id: go
              
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v1
              with:
                node-version: ${{ matrix.node-version }}
              

            - name: Check out code into the Go module directory
              uses: actions/checkout@v2

            - name: Get dependencies (gobuffalo)
              run: |
                go get -v -u github.com/gobuffalo/packr/v2/... 
                echo ::set-output name=status::success
              continue-on-error: true

            - name: Get dependencies
              run: |
                go get -v -t -d ./...
                echo ::set-output name=status::success
              continue-on-error: true
              
            - name: Dump steps context
              env:
                STEPS_CONTEXT: ${{ toJson(steps) }}
              run: echo "$STEPS_CONTEXT"

    test:
        runs-on: ubuntu-latest
        needs: prepare
        steps:
            - name: Prepare Test Env
              uses: actions/setup-go@v1
              with:
                go-version: 1.13
            - name: Check out code into the Go module directory
              uses: actions/checkout@v2
              
            - name: Test
              run: |
                make test
                echo ::set-output name=status::success
              continue-on-error: true

    build:
        runs-on: ubuntu-latest
        needs: test
        name: Build
        steps:
            - name: Build
              run: make build

    publish:             
        runs-on: ubuntu-latest
        needs: build

        steps:
            - uses: actions/setup-node@v1
              with:
                node-version: 12
                registry-url: https://registry.npmjs.org/
            - name: Publish
              run: make test
      
